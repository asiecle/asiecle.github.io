<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Puntos - Triatlón</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: url('https://source.unsplash.com/1600x900/?running,track') no-repeat center center/cover;
            color: #fff;
            margin: 0;
            padding: 0;
        }
        .container {
            background: rgba(0, 0, 0, 0.7);
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(255, 255, 255, 0.3);
        }
        h2, h3 {
            color: #ffcc00;
        }
        label {
            display: block;
            margin-top: 10px;
            font-size: 18px;
        }
        input {
            font-size: 18px;
            text-align: center;
            padding: 5px;
            margin-top: 5px;
            border-radius: 5px;
            border: none;
            width: 80px;
        }
        #marca3 {
            width: 100px;
        }
        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 18px;
            background: #ffcc00;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: #000;
            font-weight: bold;
        }
        button:hover {
            background: #ffaa00;
        }
        p {
            font-size: 20px;
            font-weight: bold;
            margin: 5px 0;
        }
        .resultado {
            color: #ffcc00;
        }
        .input-container {
            position: relative;
            display: inline-block;
        }
        .clear-btn {
            position: absolute;
            right: 5px;
            top: 10%;
            
            background: red;
            color: white;
            border: none;
            border-radius: 10%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            cursor: pointer;
            line-height: 18px;
            text-align: center;
    }
    </style>
</head>
<body>
    <div class="container">
        <h2>Calculadora de Puntos </h2>
        <h2>Triatlón B Femenino </h2>

        <h3>Introduce las marcas:</h3>
        
        <label>1000m (mm:ss.cc): <input type="text" id="marca3" placeholder="Ej: 03:15.25" pattern="\\d{2}:\\d{2}\\.\\d{2}" title="Formato: mm:ss.cc" onblur="mostrarPuntos('marca3', 'resultado3', datos1000)" onfocus="this.select"></label>
        <p id="resultado3" class="resultado"></p>

        <label>Longitud (metros):
            <div class="input-container">
                <input type="text" id="marca1" placeholder="Ej: 8,75" onfocus="this.select()" onblur="mostrarPuntos('marca1', 'resultado1', datosLongitud)">
                <button class="clear-btn" onclick="document.getElementById('marca1').value = ''; document.getElementById('resultado1').innerText = '';">×</button>
            </div>
        <p id="resultado1" class="resultado"></p>

        <label>Jabalina (metros): <input type="text" id="marca2" placeholder="Ej: 10,45" onblur="mostrarPuntos('marca2', 'resultado2', datosJabalina)" onfocus="this.select"></label>
        <p id="resultado2" class="resultado"></p>

        <button onclick="calcularPuntos()">Calcular Total</button>
        
        <h3>Resultado Total:</h3>
        <p id="resultadoTotal" class="resultado"></p>
    </div>

    <script>
        let datosLongitud = [];
        let datosJabalina = [];
        let datos1000 = [];

        function cargarCSV(url, callback) {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`No se pudo cargar ${url}`);
                    return response.text();
                })
                .then(texto => {
                    let datos = texto.split("\n").map(fila => fila.split(";")).slice(1);
                    datos = datos.map(fila => [
                        convertirFormato(fila[0]),
                        parseInt(fila[1])
                    ]);
                    callback(datos);
                })
                .catch(error => alert(error.message));
        }

        function convertirFormato(valor) {
            if (valor.includes(":")) {
                let partes = valor.split(":");
                let minutos = parseInt(partes[0]);
                let segundos = parseFloat(partes[1].replace(",", "."));
                return minutos * 60 + segundos;
            } else {
                return parseFloat(valor.replace(",", "."));
            }
        }

        cargarCSV("LongitudFem.csv", datos => datosLongitud = datos);
        cargarCSV("JabalinaFem.csv", datos => datosJabalina = datos);
        cargarCSV("1000Fem.csv", datos => datos1000 = datos);

        function buscarPuntos(marca, datos) {
            if (datos.length === 0) {
                alert("Los datos aún no han sido cargados. Inténtalo de nuevo.");
                return null;
            }

            let marcaNum = convertirFormato(marca);
            let marcaMasCercana = datos.reduce((a, b) => 
                Math.abs(b[0] - marcaNum) < Math.abs(a[0] - marcaNum) ? b : a
            );

            if (!marcaMasCercana) {
                alert("La marca introducida no se encuentra en el archivo.");
                return null;
            }

            return marcaMasCercana[1]; 
        }

        function mostrarPuntos(inputId, resultadoId, datos) {
            let marca = document.getElementById(inputId).value.trim();
            if (!marca) {
                document.getElementById(resultadoId).innerText = "";
                return;
            }

            let puntos = buscarPuntos(marca, datos);
            if (puntos !== null) {
                document.getElementById(resultadoId).innerText = `Puntos: ${puntos}`;
            }
        }

        function calcularPuntos() {
            if (datosLongitud.length === 0 || datosJabalina.length === 0 || datos1000.length === 0) {
                alert("Los archivos CSV aún no han sido cargados.");
                return;
            }

            let marca1 = document.getElementById("marca1").value.trim();
            let marca2 = document.getElementById("marca2").value.trim();
            let marca3 = document.getElementById("marca3").value.trim();

            if (!marca1 || !marca2 || !marca3) {
                alert("Introduce las tres marcas.");
                return;
            }

            let puntos1 = buscarPuntos(marca1, datosLongitud);
            let puntos2 = buscarPuntos(marca2, datosJabalina);
            let puntos3 = buscarPuntos(marca3, datos1000);

            if (puntos1 === null || puntos2 === null || puntos3 === null) {
                return;
            }

            let puntosTotales = puntos1 + puntos2 + puntos3;

            document.getElementById("resultadoTotal").innerText = `Puntos Totales: ${puntosTotales}`;
        }
    </script>
</body>
</html>