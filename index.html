<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Puntos - Triatlón</title>
</head>
<body>
    <h2>Calculadora de Puntos - Triatlón</h2>

    <h3>Introduce las marcas:</h3>
    <label>Peso (metros): <input type="text" id="marca1" placeholder="Ej: 8,75" onblur="mostrarPuntos('marca1', 'resultado1', datosPeso)"></label>
    <p id="resultado1"></p>

    <label>80m (metros): <input type="text" id="marca2" placeholder="Ej: 10,45" onblur="mostrarPuntos('marca2', 'resultado2', datos80)"></label>
    <p id="resultado2"></p>

    <label>1000m (mm:ss.cc): <input type="text" id="marca3" placeholder="Ej: 03:15.25" pattern="\\d{2}:\\d{2}\\.\\d{2}" title="Formato: mm:ss.cc" onblur="mostrarPuntos('marca3', 'resultado3', datos1000)"></label>
    <p id="resultado3"></p>

    <button onclick="calcularPuntos()">Calcular Total</button>
    
    <h3>Resultado Total:</h3>
    <p id="resultadoTotal"></p>

    <script>
        let datosPeso = [];
        let datos80 = [];
        let datos1000 = [];

        function cargarCSV(url, callback) {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`No se pudo cargar ${url}`);
                    return response.text();
                })
                .then(texto => {
                    let datos = texto.split("\n").map(fila => fila.split(";")).slice(1); // Omitir encabezado
                    datos = datos.map(fila => [
                        convertirFormato(fila[0]), // Convertir valores al formato correcto
                        parseInt(fila[1]) // Puntos como número entero
                    ]);
                    callback(datos);
                })
                .catch(error => alert(error.message));
        }

        // Convertir formato según tipo de dato
        function convertirFormato(valor) {
            if (valor.includes(":")) {
                // Convertir mm:ss.cc a segundos con decimales
                let partes = valor.split(":");
                let minutos = parseInt(partes[0]);
                let segundos = parseFloat(partes[1].replace(",", "."));
                return minutos * 60 + segundos;
            } else {
                // Convertir metros con coma a número con punto
                return parseFloat(valor.replace(",", "."));
            }
        }

        // Cargar los archivos CSV automáticamente al iniciar
        cargarCSV("PesoFem.csv", datos => datosPeso = datos);
        cargarCSV("80Fem.csv", datos => datos80 = datos);
        cargarCSV("1000Fem.csv", datos => datos1000 = datos);

        function buscarPuntos(marca, datos) {
            if (datos.length === 0) {
                alert("Los datos aún no han sido cargados. Inténtalo de nuevo.");
                return null;
            }

            let marcaNum = convertirFormato(marca);
            let marcaMasCercana = datos.reduce((a, b) => 
                Math.abs(b[0] - marcaNum) < Math.abs(a[0] - marcaNum) ? b : a
            );

            if (!marcaMasCercana) {
                alert("La marca introducida no se encuentra en el archivo.");
                return null;
            }

            return marcaMasCercana[1]; // Devolver puntos de la marca más cercana
        }

        function mostrarPuntos(inputId, resultadoId, datos) {
            let marca = document.getElementById(inputId).value.trim();
            if (!marca) {
                document.getElementById(resultadoId).innerText = "";
                return;
            }

            let puntos = buscarPuntos(marca, datos);
            if (puntos !== null) {
                document.getElementById(resultadoId).innerText = `Puntos: ${puntos}`;
            }
        }

        function calcularPuntos() {
            if (datosPeso.length === 0 || datos80.length === 0 || datos1000.length === 0) {
                alert("Los archivos CSV aún no han sido cargados.");
                return;
            }

            let marca1 = document.getElementById("marca1").value.trim();
            let marca2 = document.getElementById("marca2").value.trim();
            let marca3 = document.getElementById("marca3").value.trim();

            if (!marca1 || !marca2 || !marca3) {
                alert("Introduce las tres marcas.");
                return;
            }

            let puntos1 = buscarPuntos(marca1, datosPeso);
            let puntos2 = buscarPuntos(marca2, datos80);
            let puntos3 = buscarPuntos(marca3, datos1000);

            if (puntos1 === null || puntos2 === null || puntos3 === null) {
                return;
            }

            let puntosTotales = puntos1 + puntos2 + puntos3;

            document.getElementById("resultadoTotal").innerText = `Puntos Totales: ${puntosTotales}`;
        }
    </script>
</body>
</html>